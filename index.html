<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Procesador de Liquidaci칩n</title>
<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  background: #f5f5f5;
}

textarea {
  width: 100%;
  height: 180px;
  margin-bottom: 15px;
  font-family: monospace;
  font-size: 13px;
}

button {
  padding: 10px 20px;
  margin-right: 10px;
  cursor: pointer;
}

table {
  border-collapse: collapse;
  margin-top: 20px;
  background: white;
}

th, td {
  border: 1px solid #ccc;
  padding: 4px 8px;
  font-size: 12px;
  text-align: center;
}

th { background: #eee; }

.mismatch { background: #ffd6d6; }
.correct { background: #d6ffd6; }

.tariff-row {
  background: #f0f8ff;
  font-weight: bold;
}
</style>
</head>
<body>

<h2>Procesador de Liquidaci칩n</h2>

<textarea id="input" placeholder="Peg치 ac치 la tabla copiada..."></textarea>
<button onclick="process()">Procesar</button>
<button onclick="downloadCSV()">Descargar CSV</button>

<div id="result"></div>

<script>
let processedData = [];

function parseMoney(str) {
  if (!str) return 0;
  return Number(
    str.replace(/\$/g,"")
       .replace(/\./g,"")
       .replace(",",".")
       .replace(/\s/g,"")
  ) || 0;
}

function formatMoney(num) {
  return "$ " + num.toLocaleString("es-AR");
}

function process() {
  const input = document.getElementById("input").value.trim();
  if (!input) return;

  const rows = input.split("\n");
  const originalHeaders = rows[0].split("\t");

  // Identify quantity columns (exclude TARIFA columns)
  let quantityIndexes = [];
  let tariffMap = {};

  for (let i = 0; i < originalHeaders.length; i++) {
    if (!originalHeaders[i].includes("TARIFA")) {
      quantityIndexes.push(i);
    } else {
      // map tariff to previous quantity column
      tariffMap[i - 1] = i;
    }
  }

  let newHeaders = quantityIndexes.map(i => originalHeaders[i]);
  newHeaders.push("TOTAL RECALCULADO", "DIFERENCIA");

  processedData = [newHeaders];

  let html = "<table><tr>";
  newHeaders.forEach(h => html += "<th>"+h+"</th>");
  html += "</tr>";

  let tariffsRow = Array(newHeaders.length).fill("");

  for (let r = 1; r < rows.length; r++) {
    if (rows[r].startsWith("Suma")) continue;

    let cols = rows[r].split("\t");

    let newRow = [];

    function val(i){ return parseMoney(cols[i]); }

    let total = 0;

    quantityIndexes.forEach((qi, idx) => {
      newRow.push(cols[qi]);

      if (tariffMap[qi] !== undefined) {
        let tariffValue = parseMoney(cols[tariffMap[qi]]);
        let qtyValue = parseMoney(cols[qi]);
        total += qtyValue * tariffValue;

        // store tariff only once
        if (!tariffsRow[idx]) {
          tariffsRow[idx] = formatMoney(tariffValue);
        }
      }
    });

    // add bonos + excepc if present
    let bonos = parseMoney(cols[30] || 0);
    let excepc = parseMoney(cols[31] || 0);
    total += bonos + excepc;

    let originalTotal = parseMoney(cols[32] || 0);
    let diff = total - originalTotal;

    newRow.push(formatMoney(total));
    newRow.push(diff !== 0 ? formatMoney(diff) : "-");

    processedData.push(newRow);

    html += "<tr>";
    newRow.forEach((cell, i) => {
      if (i === newRow.length - 1) {
        html += `<td class="${diff !== 0 ? 'mismatch':'correct'}">${cell}</td>`;
      } else {
        html += "<td>"+cell+"</td>";
      }
    });
    html += "</tr>";
  }

  // Add tariffs row
  html += "<tr class='tariff-row'>";
  html += "<td>TARIFAS</td>";
  tariffsRow.slice(1).forEach(t => html += "<td>"+t+"</td>");
  html += "</tr>";

  html += "</table>";

  document.getElementById("result").innerHTML = html;
}

function downloadCSV() {
  if (!processedData.length) return;

  let csv = processedData.map(row =>
    row.map(cell => `"${cell}"`).join(",")
  ).join("\n");

  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "liquidacion_procesada.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>

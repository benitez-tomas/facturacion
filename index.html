<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Procesador de Liquidación</title>
<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  background: #f5f5f5;
}

textarea {
  width: 100%;
  height: 180px;
  margin-bottom: 15px;
  font-family: monospace;
  font-size: 13px;
}

button {
  padding: 10px 20px;
  margin-right: 10px;
  cursor: pointer;
}

table {
  border-collapse: collapse;
  margin-top: 20px;
  background: white;
}

th, td {
  border: 1px solid #ccc;
  padding: 4px 8px;
  font-size: 12px;
  text-align: center;
}

th { background: #eee; }

.mismatch { background: #ffd6d6; }
.correct { background: #d6ffd6; }

.tariff-row {
  background: #e6f2ff;
  font-weight: bold;
}
</style>
</head>
<body>

<h2>Procesador de Liquidación</h2>

<textarea id="input" placeholder="Pegá acá la tabla copiada..."></textarea>
<button onclick="process()">Procesar</button>

<div id="result"></div>

<script>

function parseMoney(str) {
  if (!str) return 0;
  return Number(
    str.replace(/\$/g,"")
       .replace(/\./g,"")
       .replace(",",".")
       .replace(/\s/g,"")
  ) || 0;
}

function formatMoney(num) {
  return "$ " + num.toLocaleString("es-AR");
}

function process() {
  const input = document.getElementById("input").value.trim();
  if (!input) return;

  const rows = input.split("\n").map(r => r.split("\t"));
  const headers = rows[0].map(h => h.trim());

  const upperHeaders = headers.map(h => h.toUpperCase());

  const isTariff = upperHeaders.map(h => h.includes("TARIFA"));

  // Detect special columns
  const bonosIndex = upperHeaders.indexOf("BONOS");
  const excepcIndex = upperHeaders.indexOf("EXCEPC.");
  const totalIndex = upperHeaders.indexOf("TOTAL DIA");

  // Keep only non-tariff columns
  const keptIndexes = headers
    .map((_, i) => i)
    .filter(i => !isTariff[i]);

  // Map quantity → tariff column
  const tariffMap = {};
  headers.forEach((h, i) => {
    if (isTariff[i]) {
      const baseName = h.replace(/TARIFA\s*/i, "").trim().toUpperCase();
      const baseIndex = upperHeaders.findIndex(
        x => x === baseName
      );
      if (baseIndex !== -1) {
        tariffMap[baseIndex] = i;
      }
    }
  });

  let html = "<table><tr>";

  const newHeaders = keptIndexes.map(i => headers[i]);
  newHeaders.push("TOTAL RECALCULADO", "DIFERENCIA");

  newHeaders.forEach(h => html += "<th>"+h+"</th>");
  html += "</tr>";

  let tariffsRow = Array(newHeaders.length).fill("");

  for (let r = 1; r < rows.length; r++) {
    if (rows[r][0].toUpperCase().includes("SUMA")) continue;

    const row = rows[r];
    let total = 0;

    html += "<tr>";

    keptIndexes.forEach((colIndex, newColIndex) => {

      html += "<td>"+(row[colIndex] || "")+"</td>";

      if (tariffMap[colIndex] !== undefined) {
        const qty = parseMoney(row[colIndex]);
        const tariff = parseMoney(row[tariffMap[colIndex]]);
        total += qty * tariff;

        if (!tariffsRow[newColIndex]) {
          tariffsRow[newColIndex] = formatMoney(tariff);
        }
      }
    });

    // ✅ Add BONOS and EXCEPC explicitly
    if (bonosIndex !== -1) {
      total += parseMoney(row[bonosIndex]);
    }

    if (excepcIndex !== -1) {
      total += parseMoney(row[excepcIndex]);
    }

    const originalTotal =
      totalIndex !== -1
        ? parseMoney(row[totalIndex])
        : 0;

    const diff = total - originalTotal;

    html += `<td>${formatMoney(total)}</td>`;
    html += `<td class="${diff !== 0 ? 'mismatch':'correct'}">${
      diff !== 0 ? formatMoney(diff) : "-"
    }</td>`;

    html += "</tr>";
  }

  // Add tariffs row
  html += "<tr class='tariff-row'>";
  html += "<td>TARIFAS</td>";
  for (let i = 1; i < tariffsRow.length; i++) {
    html += "<td>"+(tariffsRow[i] || "")+"</td>";
  }
  html += "</tr>";

  html += "</table>";

  document.getElementById("result").innerHTML = html;
}

</script>

</body>
</html>
